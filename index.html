<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每周课程表</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .tabs {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px; /* Distance between tabs and content */
        }
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background-color: #f0f0f0;
            border-radius: 5px;
            font-weight: bold;
        }
        .tab-button.active {
            background-color: #ccc;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            white-space: pre-line; /* Ensures line breaks are respected */
        }
        th {
            background-color: #f2f2f2;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 30%;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .completed-courses {
            margin-top: 20px;
        }
        .date-group {
            margin-bottom: 10px;
        }
        .date-header {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .completed-course-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
        }
        .completed {
            color: green;
        }
        .total-points {
            margin-top: 20px;
            font-size: 1.2em;
            font-weight: bold;
        }
        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 5px;
            padding: 16px;
            position: fixed;
            z-index: 1;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
        }
        .toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }
        @keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }
        @keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }
        .exchange-modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .exchange-modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 30%;
        }
        .exchange-input {
            margin-bottom: 10px;
        }
        .exchange-button {
            margin-right: 10px;
        }
        .exchange-record {
            margin-top: 20px;
        }
        .record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
        }
        .exchange-button-container {
            display: inline-block;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <h2>每周课程表</h2>

    <div class="tabs">
        <button id="schedule-tab" class="tab-button active" onclick="showTab('schedule')">课程表</button>
        <button id="records-tab" class="tab-button" onclick="showTab('records')">完成记录</button>
        <button id="exchange-tab" class="tab-button" onclick="showTab('exchange')">兑换记录</button>
    </div>

    <div id="schedule" class="tab-content" style="display: block;">
        <table id="course-table">
            <thead>
                <tr>
                    <th>星期一</th>
                    <th>星期二</th>
                    <th>星期三</th>
                    <th>星期四</th>
                    <th>星期五</th>
                    <th>星期六</th>
                    <th>星期日</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be dynamically generated -->
            </tbody>
        </table>
    </div>

    <div id="records" class="tab-content" style="display: none;">
        <div class="total-points" id="total-points">
            总积分: <span id="points-count">0</span>
            <button class="exchange-button-container" onclick="openExchangeModal()">兑换积分</button>
        </div>
        <div class="completed-courses" id="completed-courses">
            <!-- Completed courses will be dynamically generated -->
        </div>
    </div>

    <div id="exchange" class="tab-content" style="display: none;">
        <button onclick="openExchangeModal()">兑换积分</button>
        <div class="exchange-record" id="exchange-record">
            <!-- Exchange records will be dynamically generated -->
        </div>
    </div>

    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <p id="modal-message"></p>
            <button id="confirm-button"></button>
            <button onclick="closeModal()">关闭</button>
        </div>
    </div>

    <div id="exchangeModal" class="exchange-modal">
        <div class="exchange-modal-content">
            <span class="close">&times;</span>
            <h3>兑换积分</h3>
            <div class="exchange-input">
                <label for="exchange-points">积分数量:</label>
                <input type="number" id="exchange-points" min="1">
            </div>
            <div class="exchange-input">
                <label for="exchange-item">商品名称:</label>
                <input type="text" id="exchange-item">
            </div>
            <button class="exchange-button" onclick="exchangePoints()">兑换</button>
            <button onclick="closeExchangeModal()">关闭</button>
        </div>
    </div>

    <div id="toast" class="toast">+1 积分</div>

    <script>
        const scheduleData = [
            ["放学\n14:55", "放学\n14:05", "放学\n14:55", "放学\n17:05", "放学\n14:55", "户外运动\n11:30-12:30", "户外运动\n10:30-12:30"],
            ["户外运动\n14:55-16:30", "户外运动\n14:05-16:30", "户外运动\n14:55-17:00", "户外运动\n17:00-18:00", "户外运动\n14:05-16:30", "户外运动\n14:05-16:30", "户外运动\n12:30-13:30"],
            ["练字\n16:30-17:00", "户外运动\n16:30-18:00", "乒乓球\n17:00-18:30", "练字\n19:00-19:30", "练字\n16:30-17:00", "户外运动\n13:30-15:30", "英语网课\n14:20-15:30"],
            ["乒乓球\n18:00-19:30", "练字、英语、数学\n19:00-20:00", "练字、拼音、英语\n20:00-21:00", "英语、数学\n20:30-21:00", "乒乓球\n18:00-19:30", "拼音、英语、数学\n19:00-20:00", "户外\n15:30-17:30"],
            ["英语\n20:15-20:45", "睡前阅读\n21:00", "睡前阅读\n21:00", "睡前阅读\n21:00", "睡前阅读\n21:00", "睡前阅读\n19:00-20:00", "睡前阅读\n19:00-20:00"]
        ];

        let completedCourses = JSON.parse(localStorage.getItem("completedCourses")) || [];
        let points = parseInt(localStorage.getItem("points")) || 0;
        let exchangeRecords = JSON.parse(localStorage.getItem("exchangeRecords")) || [];

        function renderSchedule() {
            const tbody = document.querySelector("#course-table tbody");
            tbody.innerHTML = "";

            scheduleData.forEach(row => {
                const tr = document.createElement("tr");
                row.forEach(cell => {
                    const td = document.createElement("td");
                    td.textContent = cell;
                    td.onclick = () => openModal(td, cell.split('\n')[0]);
                    if (isCourseCompleted(cell.split('\n')[0], getCellIdentifier(td))) {
                        td.classList.add("completed");
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        function isCourseCompleted(courseName, cellIdentifier) {
            return completedCourses.some(course => course.name === courseName && course.cell === cellIdentifier);
        }

        function getCellIdentifier(td) {
            if (!td || !td.parentNode || typeof td.cellIndex !== 'number' || typeof td.parentNode.rowIndex !== 'number') {
                console.error("Invalid cell element provided.");
                return null;
            }
            const rowIndex = td.parentNode.rowIndex;
            const colIndex = td.cellIndex;
            return `${rowIndex}-${colIndex}`;
        }

        function renderCompletedCourses() {
            const container = document.getElementById("completed-courses");
            container.innerHTML = "";

            // Group courses by completion date
            const groupedCourses = completedCourses.reduce((acc, course) => {
                const dateKey = new Date(course.completedAt).toLocaleDateString();
                if (!acc[dateKey]) {
                    acc[dateKey] = [];
                }
                acc[dateKey].push(course);
                return acc;
            }, {});

            Object.keys(groupedCourses).sort((a, b) => new Date(b) - new Date(a)).forEach(dateKey => {
                const dateGroupDiv = document.createElement("div");
                dateGroupDiv.className = "date-group";

                const dateHeader = document.createElement("div");
                dateHeader.className = "date-header";
                dateHeader.textContent = dateKey;
                dateGroupDiv.appendChild(dateHeader);

                groupedCourses[dateKey].forEach(course => {
                    const div = document.createElement("div");
                    div.className = "completed-course-item";
                    div.innerHTML = `${course.name} (+${course.points} 分) <button onclick="deleteCourse('${course.name}', '${course.cell}')">删除</button>`;
                    dateGroupDiv.appendChild(div);
                });

                container.appendChild(dateGroupDiv);
            });

            updateTotalPoints();
        }

        function renderExchangeRecords() {
            const container = document.getElementById("exchange-record");
            container.innerHTML = "";

            exchangeRecords.forEach(record => {
                const div = document.createElement("div");
                div.className = "record-item";
                div.textContent = `${record.item}: ${record.points} 分`;
                container.appendChild(div);
            });
        }

        function showTab(tabName) {
            document.querySelectorAll(".tab-button").forEach(button => button.classList.remove("active"));
            document.getElementById(`${tabName}-tab`).classList.add("active");
            document.querySelectorAll(".tab-content").forEach(content => content.style.display = "none");
            document.getElementById(tabName).style.display = "block";
        }

        function openModal(td, courseName) {
            if (!td || !td.parentNode || typeof td.cellIndex !== 'number' || typeof td.parentNode.rowIndex !== 'number') {
                console.error("Invalid cell element provided.");
                return;
            }
            document.getElementById("myModal").style.display = "block";
            window.currentCourse = courseName;
            currentCell = td;
            const cellIdentifier = getCellIdentifier(currentCell);
            if (!cellIdentifier) {
                console.error("Failed to get cell identifier.");
                closeModal();
                return;
            }
            if (isCourseCompleted(window.currentCourse, cellIdentifier)) {
                document.getElementById("modal-message").textContent = "取消已完成状态？";
                document.getElementById("confirm-button").textContent = "取消";
                document.getElementById("confirm-button").onclick = unmarkAsCompleted;
            } else {
                document.getElementById("modal-message").textContent = "标记为已完成？";
                document.getElementById("confirm-button").textContent = "确定";
                document.getElementById("confirm-button").onclick = markAsCompleted;
            }
        }

        function closeModal() {
            document.getElementById("myModal").style.display = "none";
            currentCell = null; // Clear the current cell after closing the modal
        }

        function markAsCompleted() {
            if (!currentCell) {
                console.error("Current cell is not set.");
                closeModal();
                return;
            }
            const now = new Date();
            const cellIdentifier = getCellIdentifier(currentCell);
            if (!cellIdentifier) {
                console.error("Failed to get cell identifier.");
                closeModal();
                return;
            }
            completedCourses.push({ name: window.currentCourse, completedAt: now.toISOString(), cell: cellIdentifier, points: 1 });
            localStorage.setItem("completedCourses", JSON.stringify(completedCourses));
            points += 1;
            localStorage.setItem("points", points.toString());
            currentCell.classList.add("completed"); // Add the 'completed' class to the current cell
            closeModal();
            renderCompletedCourses();
            showToast();
        }

        function unmarkAsCompleted() {
            if (!currentCell) {
                console.error("Current cell is not set.");
                closeModal();
                return;
            }
            const cellIdentifier = getCellIdentifier(currentCell);
            if (!cellIdentifier) {
                console.error("Failed to get cell identifier.");
                closeModal();
                return;
            }
            const removedCourse = completedCourses.find(course => course.name === window.currentCourse && course.cell === cellIdentifier);
            if (removedCourse) {
                points -= removedCourse.points;
                localStorage.setItem("points", points.toString());
            }
            completedCourses = completedCourses.filter(course => !(course.name === window.currentCourse && course.cell === cellIdentifier));
            localStorage.setItem("completedCourses", JSON.stringify(completedCourses));
            currentCell.classList.remove("completed"); // Remove the 'completed' class from the current cell
            closeModal();
            renderCompletedCourses();
        }

        function deleteCourse(courseName, cellIdentifier) {
            const removedCourse = completedCourses.find(course => course.name === courseName && course.cell === cellIdentifier);
            if (removedCourse) {
                points -= removedCourse.points;
                localStorage.setItem("points", points.toString());
            }
            completedCourses = completedCourses.filter(course => !(course.name === courseName && course.cell === cellIdentifier));
            localStorage.setItem("completedCourses", JSON.stringify(completedCourses));
            const cellToUnmark = document.querySelector(`#course-table tbody tr:nth-child(${parseInt(cellIdentifier.split('-')[0]) + 1}) td:nth-child(${parseInt(cellIdentifier.split('-')[1]) + 1})`);
            if (cellToUnmark) {
                cellToUnmark.classList.remove("completed");
            } else {
                console.error("Cell to unmark not found.");
            }
            renderCompletedCourses();
        }

        function updateTotalPoints() {
            document.getElementById("points-count").textContent = points;
        }

        function showToast() {
            var toast = document.getElementById("toast");
            toast.className = "toast show";
            setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
        }

        function openExchangeModal() {
            document.getElementById("exchangeModal").style.display = "block";
        }

        function closeExchangeModal() {
            document.getElementById("exchangeModal").style.display = "none";
        }

        function exchangePoints() {
            const exchangePointsInput = document.getElementById("exchange-points");
            const exchangeItemInput = document.getElementById("exchange-item");

            const pointsToExchange = parseInt(exchangePointsInput.value);
            const itemName = exchangeItemInput.value.trim();

            if (isNaN(pointsToExchange) || pointsToExchange <= 0) {
                alert("请输入有效的积分数量。");
                return;
            }

            if (itemName === "") {
                alert("请输入商品名称。");
                return;
            }

            if (points < pointsToExchange) {
                alert("积分不足，无法兑换。");
                return;
            }

            points -= pointsToExchange;
            localStorage.setItem("points", points.toString());

            const now = new Date();
            exchangeRecords.push({ item: itemName, points: pointsToExchange, exchangedAt: now.toISOString() });
            localStorage.setItem("exchangeRecords", JSON.stringify(exchangeRecords));

            closeExchangeModal();
            renderExchangeRecords();
            updateTotalPoints();
        }

        document.querySelector(".close").onclick = closeModal;

        document.querySelector(".exchange-modal .close").onclick = closeExchangeModal;

        window.onclick = function(event) {
            if (event.target.id === "myModal") {
                closeModal();
            }
            if (event.target.id === "exchangeModal") {
                closeExchangeModal();
            }
        };

        renderSchedule();
        renderCompletedCourses();
        renderExchangeRecords();
    </script>
</body>
</html>



